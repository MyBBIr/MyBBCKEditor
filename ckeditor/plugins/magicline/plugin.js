"use strict";!function(){function t(t){function e(){function e(e){C.debug.groupStart("CheckMouse"),C.debug.startTimer(),C.mouse=e,C.trigger=null,m=null,x(C),p&&!C.hiddenMode&&t.focusManager.hasFocus&&!C.line.mouseNear()&&(C.element=X(C,!0))&&((C.trigger=g(C)||b(C)||Q(C))?C.line.attach().place():(C.trigger=null,C.line.detach()),C.debug.showTrigger(C.trigger),C.debug.mousePos(e.y,C.element),p=!1),C.debug.stopTimer(),C.debug.groupEnd()}var a=t.editable(),c=t.document,d=t.window;H(C,{editable:a,inInlineMode:a.isInline(),doc:c,win:d},!0),C.boundary=C.inInlineMode?C.editable:C.doc.getDocumentElement(),a.is($.$inline)||(C.inInlineMode&&!_(a)&&a.setStyles({position:"relative",top:null,left:null}),r.call(this,C),x(C),a.attachListener(t,"beforeUndoImage",function(){C.line.detach()}),a.attachListener(t,"beforeGetData",function(){C.line.wrap.getParent()&&(C.line.detach(),t.once("getData",function(){C.line.attach()},null,null,1e3))},null,null,0),a.attachListener(C.inInlineMode?c:c.getWindow().getFrame(),"mouseout",function(e){if("wysiwyg"==t.mode)if(C.inInlineMode){var s={x:e.data.$.clientX,y:e.data.$.clientY};x(C),P(C,!0);var i=C.view.editable,a=C.view.scroll;o(s.x,i.left-a.x,i.right-a.x)&&o(s.y,i.top-a.y,i.bottom-a.y)||(clearTimeout(m),m=null,C.line.detach())}else clearTimeout(m),m=null,C.line.detach()}),a.attachListener(a,"keyup",function(){C.hiddenMode=0,C.debug.showHidden(C.hiddenMode)}),a.attachListener(a,"keydown",function(e){if("wysiwyg"==t.mode){var s=e.data.getKeystroke(),i=t.getSelection();switch(i.getStartElement(),s){case 2228240:case 16:C.hiddenMode=1,C.line.detach()}C.debug.showHidden(C.hiddenMode)}}),a.attachListener(C.inInlineMode?a:c,"mousemove",function(s){if(p=!0,"wysiwyg"==t.mode&&!t.readOnly&&!m){var i={x:s.data.$.clientX,y:s.data.$.clientY};m=setTimeout(function(){e(i)},30)}}),a.attachListener(d,"scroll",function(){"wysiwyg"==t.mode&&(C.line.detach(),k.webkit&&(C.hiddenMode=1,clearTimeout(u),u=setTimeout(function(){C.hiddenMode=0,C.debug.showHidden(C.hiddenMode)},50),C.debug.showHidden(C.hiddenMode)))}),a.attachListener(d,"mousedown",function(){"wysiwyg"==t.mode&&(C.line.detach(),C.hiddenMode=1,C.debug.showHidden(C.hiddenMode))}),a.attachListener(d,"mouseup",function(){C.hiddenMode=0,C.debug.showHidden(C.hiddenMode)}),t.addCommand("accessPreviousSpace",v(C)),t.addCommand("accessNextSpace",v(C,!0)),t.setKeystroke([[f.magicline_keystrokePrevious,"accessPreviousSpace"],[f.magicline_keystrokeNext,"accessNextSpace"]]),t.on("loadSnapshot",function(){for(var e,s=t.document.getElementsByTag(C.enterBehavior),i=s.count();i--;)if((e=s.getItem(i)).hasAttribute("data-cke-magicline-hot")){C.hotNode=e,C.lastCmdDirection="true"===e.getAttribute("data-cke-magicline-dir")?!0:!1;break}}),this.backdoor={accessFocusSpace:h,boxTrigger:s,isLine:l,getAscendantTrigger:i,getNonEmptyNeighbour:n,getSize:y,that:C,triggerEdge:b,triggerEditable:g,triggerExpand:Q})}var a={};a[CKEDITOR.ENTER_BR]="br",a[CKEDITOR.ENTER_P]="p",a[CKEDITOR.ENTER_DIV]="div";var u,p,m,f=t.config,w=f.magicline_triggerOffset||30,T=f.enterMode,C={editor:t,enterBehavior:a[T],enterMode:T,triggerOffset:w,holdDistance:0|w*(f.magicline_holdDistance||.5),boxColor:f.magicline_color||"#ff0000",rtl:"rtl"==f.contentsLangDirection,triggers:f.magicline_everywhere?B:{table:1,hr:1,div:1,ul:1,ol:1,dl:1,form:1,blockquote:1,code:1}};try{C.debug=window.top.DEBUG}catch(V){}C.debug=C.debug||{groupEnd:function(){},groupStart:function(){},log:function(){},logElements:function(){},logElementsEnd:function(){},logEnd:function(){},mousePos:function(){},showHidden:function(){},showTrigger:function(){},startTimer:function(){},stopTimer:function(){}},C.isRelevant=function(t){return c(t)&&!l(C,t)&&!d(t)},t.on("contentDom",e,this)}function e(t,e,s){return c(e)&&c(s)&&s.equals(e.getNext(function(t){return!(G(t)||K(t)||d(t))}))}function s(t){this.upper=t[0],this.lower=t[1],this.set.apply(this,t.slice(2))}function i(t){var e,s=t.element;return s&&c(s)?!(e=s.getAscendant(t.triggers,!0))||e.contains(t.editable)||e.equals(t.editable)?null:e:null}function a(t,e,s){w(t,e),w(t,s);var i=e.size.bottom,a=s.size.top;return i&&a?0|(i+a)/2:i||a}function n(t,e,s){return e=e[s?"getPrevious":"getNext"](function(e){return p(e)&&!G(e)||c(e)&&!d(e)&&!l(t,e)})}function o(t,e,s){return t>e&&s>t}function r(t){var e=t.doc,s=V('<span contenteditable="false" style="'+q+"position:absolute;border-top:1px dashed "+t.boxColor+'"></span>',e);H(s,{attach:function(){return this.wrap.getParent()||this.wrap.appendTo(t.editable,!0),this},lineChildren:[H(V('<span title="'+t.editor.lang.magicline.title+'" contenteditable="false">&#8629;</span>',e),{base:q+"height:17px;width:17px;"+(t.rtl?"left":"right")+":17px;"+"background:url("+this.path+"images/icon.png) center no-repeat "+t.boxColor+";cursor:pointer;"+(k.hc?"font-size: 15px;line-height:14px;border:1px solid #fff;text-align:center;":""),looks:["top:-8px;"+CKEDITOR.tools.cssVendorPrefix("border-radius","2px",1),"top:-17px;"+CKEDITOR.tools.cssVendorPrefix("border-radius","2px 2px 0px 0px",1),"top:-1px;"+CKEDITOR.tools.cssVendorPrefix("border-radius","0px 0px 2px 2px",1)]}),H(V(U,e),{base:W+"left:0px;border-left-color:"+t.boxColor+";",looks:["border-width:8px 0 8px 8px;top:-8px","border-width:8px 0 0 8px;top:-8px","border-width:0 0 8px 8px;top:0px"]}),H(V(U,e),{base:W+"right:0px;border-right-color:"+t.boxColor+";",looks:["border-width:8px 8px 8px 0;top:-8px","border-width:8px 8px 0 0;top:-8px","border-width:0 8px 8px 0;top:0px"]})],detach:function(){return this.wrap.getParent()&&this.wrap.remove(),this},mouseNear:function(){t.debug.groupStart("mouseNear"),w(t,this);var e=t.holdDistance,s=this.size;return s&&o(t.mouse.y,s.top-e,s.bottom+e)&&o(t.mouse.x,s.left-e,s.right+e)?(t.debug.logEnd("Mouse is near."),!0):(t.debug.logEnd("Mouse isn't near."),!1)},place:function(){var e=t.view,s=t.editable,i=t.trigger,a=i.upper,n=i.lower,r=a||n,h=r.getParent(),v={};this.trigger=i,a&&w(t,a,!0),n&&w(t,n,!0),w(t,h,!0),t.inInlineMode&&P(t,!0),h.equals(s)?(v.left=e.scroll.x,v.right=-e.scroll.x,v.width=""):(v.left=r.size.left-r.size.margin.left+e.scroll.x-(t.inInlineMode?e.editable.left+e.editable.border.left:0),v.width=r.size.outerWidth+r.size.margin.left+r.size.margin.right+e.scroll.x,v.right=""),a&&n?v.top=a.size.margin.bottom===n.size.margin.top?0|a.size.bottom+a.size.margin.bottom/2:a.size.margin.bottom<n.size.margin.top?a.size.bottom+a.size.margin.bottom:a.size.bottom+a.size.margin.bottom-n.size.margin.top:a?n||(v.top=a.size.bottom+a.size.margin.bottom):v.top=n.size.top-n.size.margin.top,i.is(D)||o(v.top,e.scroll.y-15,e.scroll.y+5)?(v.top=t.inInlineMode?0:e.scroll.y,this.look(D)):i.is(M)||o(v.top,e.pane.bottom-5,e.pane.bottom+15)?(v.top=t.inInlineMode?e.editable.height+e.editable.padding.top+e.editable.padding.bottom:e.pane.bottom-1,this.look(M)):(t.inInlineMode&&(v.top-=e.editable.top+e.editable.border.top),this.look(L)),t.inInlineMode&&(v.top--,v.top+=e.editable.scroll.top,v.left+=e.editable.scroll.left);for(var l in v)v[l]=CKEDITOR.tools.cssLength(v[l]);this.setStyles(v)},look:function(t){if(this.oldLook!=t){for(var e,s=this.lineChildren.length;s--;)(e=this.lineChildren[s]).setAttribute("style",e.base+e.looks[0|t/2]);this.oldLook=t}},wrap:new C("span",t.doc)});for(var i=s.lineChildren.length;i--;)s.lineChildren[i].appendTo(s);s.look(L),s.appendTo(s.wrap),s.unselectable(),s.lineChildren[0].on("mouseup",function(e){s.detach(),h(t,function(e){var s=t.line.trigger;e[s.is(E)?"insertBefore":"insertAfter"](s.is(E)?s.lower:s.upper)},!0),t.editor.focus(),k.ie||t.enterMode==CKEDITOR.ENTER_BR||t.hotNode.scrollIntoView(),e.data.preventDefault(!0)}),s.on("mousedown",function(t){t.data.preventDefault(!0)}),t.line=s}function h(t,e,s){var i,a=new CKEDITOR.dom.range(t.doc),n=t.editor;if(k.ie&&t.enterMode==CKEDITOR.ENTER_BR)i=t.doc.createText(I);else if(i=new C(t.enterBehavior,t.doc),t.enterMode!=CKEDITOR.ENTER_BR){var o=t.doc.createText(I);o.appendTo(i)}s&&n.fire("saveSnapshot"),e(i),a.moveToPosition(i,CKEDITOR.POSITION_AFTER_START),n.getSelection().selectRanges([a]),t.hotNode=i,s&&n.fire("saveSnapshot")}function v(t,e){return{canUndo:!0,modes:{wysiwyg:1},exec:function(){function s(s){var i=k.ie&&k.version<9?" ":I,a=t.hotNode&&t.hotNode.getText()==i&&t.element.equals(t.hotNode)&&t.lastCmdDirection===!!e;h(t,function(i){a&&t.hotNode&&t.hotNode.remove(),i[e?"insertAfter":"insertBefore"](s),i.setAttributes({"data-cke-magicline-hot":1,"data-cke-magicline-dir":!!e}),t.lastCmdDirection=!!e}),k.ie||t.enterMode==CKEDITOR.ENTER_BR||t.hotNode.scrollIntoView(),t.line.detach()}return function(a){var o=a.getSelection().getStartElement();if(o=o.getAscendant(B,1),o&&!o.equals(t.editable)&&!o.contains(t.editable)){t.element=o;var r,h=n(t,o,!e);if(c(h)&&h.is(t.triggers)&&h.is(j)&&(!n(t,h,!e)||(r=n(t,h,!e))&&c(r)&&r.is(t.triggers)))return s(h),void 0;var v=i(t,o);if(c(v)){if(!n(t,v,!e))return s(v),void 0;var l=n(t,v,!e);return l&&c(l)&&l.is(t.triggers)?(s(v),void 0):void 0}}}}()}}function l(t,e){if(!e||e.type!=CKEDITOR.NODE_ELEMENT||!e.$)return!1;var s=t.line;return s.wrap.equals(e)||s.wrap.contains(e)}function c(t){return t&&t.type==CKEDITOR.NODE_ELEMENT&&t.$}function u(t){if(!c(t))return!1;var e={left:1,right:1,center:1};return!(!e[t.getComputedStyle("float")]&&!e[t.getAttribute("align")])}function d(t){return c(t)?_(t)||u(t):!1}function _(t){return!!{absolute:1,fixed:1,relative:1}[t.getComputedStyle("position")]}function p(t){return t&&t.type==CKEDITOR.NODE_TEXT}function m(t,e){return c(e)?e.is(t.triggers):null}function f(t,e,s){var i=e[s?"getLast":"getFirst"](function(e){return t.isRelevant(e)&&!e.is(O)});return i?(w(t,i),s?i.size.top>t.mouse.y:i.size.bottom<t.mouse.y):!1}function g(t){t.debug.groupStart("triggerEditable");var e,i=t.editable,a=t.mouse,n=t.view,r=t.triggerOffset;P(t);var h=a.y>(t.inInlineMode?n.editable.top+n.editable.height/2:Math.min(n.editable.height,n.pane.height)/2),v=i[h?"getLast":"getFirst"](function(t){return!(G(t)||K(t))});return v?(l(t,v)&&(v=t.line.wrap[h?"getPrevious":"getNext"](function(t){return!(G(t)||K(t))})),c(v)&&!d(v)&&m(t,v)?(w(t,v),!h&&v.size.top>=0&&o(a.y,0,v.size.top+r)?(e=t.inInlineMode||0===n.scroll.y?D:L,t.debug.logEnd("SUCCESS. Created box trigger. EDGE_TOP."),new s([null,v,E,N,e])):h&&v.size.bottom<=n.pane.height&&o(a.y,v.size.bottom-r,n.pane.height)?(e=t.inInlineMode||o(v.size.bottom,n.pane.height-r,n.pane.height)?M:L,t.debug.logEnd("SUCCESS. Created box trigger. EDGE_BOTTOM."),new s([v,null,F,N,e])):(t.debug.logEnd("ABORT. No trigger created."),null)):(t.debug.logEnd("ABORT. Invalid edge node."),null)):(t.debug.logEnd("ABORT. No edge node found."),null)}function b(t){t.debug.groupStart("triggerEdge");var e=t.mouse,a=t.view,r=t.triggerOffset,h=i(t);if(t.debug.logElements([h],["Ascendant trigger"],"First stage"),!h)return t.debug.logEnd("ABORT. No element, element is editable or element contains editable."),null;w(t,h);var v,l,u=Math.min(r,0|h.size.outerHeight/2),_=[];if(o(e.y,h.size.top-1,h.size.top+u))l=!1;else{if(!o(e.y,h.size.bottom-u,h.size.bottom+1))return t.debug.logEnd("ABORT. Not around of any edge."),null;l=!0}if(d(h)||f(t,h,l)||h.getParent().is(R))return t.debug.logEnd("ABORT. element is wrong",h),null;var g=n(t,h,!l);if(g){if(p(g))return t.debug.logEnd("ABORT. Sibling is non-empty text element"),null;if(c(g)){if(d(g)||!m(t,g)||g.getParent().is(R))return t.debug.logEnd("ABORT. elementSibling is wrong",g),null;_=[g,h][l?"reverse":"concat"]().concat([A,N]),t.debug.log("Configured edge trigger of EDGE_MIDDLE")}}else h.equals(t.editable[l?"getLast":"getFirst"](t.isRelevant))?(P(t),l&&o(e.y,h.size.bottom-u,a.pane.height)&&o(h.size.bottom,a.pane.height-u,a.pane.height)?v=M:o(e.y,0,h.size.top+u)&&(v=D)):v=L,_=[null,h][l?"reverse":"concat"]().concat([l?F:E,N,v,h.equals(t.editable[l?"getLast":"getFirst"](t.isRelevant))?l?M:D:L]),t.debug.log("Configured edge trigger of "+(l?"EDGE_BOTTOM":"EDGE_TOP"));return 0 in _?(t.debug.logEnd("SUCCESS. Returning a trigger."),new s(_)):(t.debug.logEnd("ABORT. No trigger generated."),null)}function y(t,e,s,i){for(var a=function(){var s=k.ie?e.$.currentStyle:t.win.$.getComputedStyle(e.$,"");return k.ie?function(t){return s[CKEDITOR.tools.cssStyleToDomStyle(t)]}:function(t){return s.getPropertyValue(t)}}(),n=e.getDocumentPosition(),o={},r={},h={},v={},l=Y.length;l--;)o[Y[l]]=parseInt(a("border-"+Y[l]+"-width"),10)||0,h[Y[l]]=parseInt(a("padding-"+Y[l]),10)||0,r[Y[l]]=parseInt(a("margin-"+Y[l]),10)||0;return(!s||i)&&x(t,i),v.top=n.y-(s?0:t.view.scroll.y),v.left=n.x-(s?0:t.view.scroll.x),v.outerWidth=e.$.offsetWidth,v.outerHeight=e.$.offsetHeight,v.height=v.outerHeight-(h.top+h.bottom+o.top+o.bottom),v.width=v.outerWidth-(h.left+h.right+o.left+o.right),v.bottom=v.top+v.outerHeight,v.right=v.left+v.outerWidth,t.inInlineMode&&(v.scroll={top:e.$.scrollTop,left:e.$.scrollLeft}),H({border:o,padding:h,margin:r,ignoreScroll:s},v,!0)}function w(t,e,s){if(!c(e))return e.size=null;if(e.size){if(e.size.ignoreScroll==s&&e.size.date>new Date-z)return t.debug.log("element.size: get from cache"),null}else e.size={};return t.debug.log("element.size: capture"),H(e.size,y(t,e,s),{date:+new Date},!0)}function P(t,e){t.view.editable=y(t,t.editable,e,!0)}function x(t,e){t.view||(t.view={});var s=t.view;if(!e&&s&&s.date>new Date-z)return t.debug.log("win.size: get from cache"),void 0;t.debug.log("win.size: capturing");var i=t.win,a=i.getScrollPosition(),n=i.getViewPaneSize();H(t.view,{scroll:{x:a.x,y:a.y,width:t.doc.$.documentElement.scrollWidth-n.width,height:t.doc.$.documentElement.scrollHeight-n.height},pane:{width:n.width,height:n.height,bottom:n.height+a.y},date:+new Date},!0)}function T(t,e,i,a){for(var n=a,o=a,r=0,h=!1,v=!1,l=t.view.pane.height,c=t.mouse;c.y+r<l&&c.y-r>0&&(h||(h=e(n,a)),v||(v=e(o,a)),!h&&c.y-r>0&&(n=i(t,{x:c.x,y:c.y-r})),!v&&c.y+r<l&&(o=i(t,{x:c.x,y:c.y+r})),!h||!v);)r+=2;return new s([n,o,null,null])}CKEDITOR.plugins.add("magicline",{lang:"en,pl,fa",init:t});var H=CKEDITOR.tools.extend,C=CKEDITOR.dom.element,V=C.createFromHtml,k=CKEDITOR.env,$=CKEDITOR.dtd,E=128,F=64,A=32,N=16,S=8,D=4,M=2,L=1,I=" ",R=$.$listItem,O=$.$tableContent,j=H({},$.$nonEditable,$.$empty),B=$.$block,z=100,q="width:0px;height:0px;padding:0px;margin:0px;display:block;z-index:9999;color:#fff;position:absolute;font-size: 0px;line-height:0px;",W=q+"border-color:transparent;display:block;border-style:solid;",U="<span>"+I+"</span>";s.prototype={set:function(t,e,s){return this.properties=t+e+(s||L),this},is:function(t){return(this.properties&t)==t}};var X=function(){function t(t,e){return new CKEDITOR.dom.element(t.$.elementFromPoint(e.x,e.y))}return function(e,s,i){if(!e.mouse)return null;var a=e.doc,n=e.line.wrap,o=i||e.mouse,r=t(a,o);return s&&l(e,r)&&(n.hide(),r=t(a,o),n.show()),r&&r.type==CKEDITOR.NODE_ELEMENT&&r.$?k.ie&&k.version<9&&!e.boundary.equals(r)&&!e.boundary.contains(r)?null:r:null}}(),G=CKEDITOR.dom.walker.whitespaces(),K=CKEDITOR.dom.walker.nodeType(CKEDITOR.NODE_COMMENT),Q=function(){function t(t){t.debug.groupStart("expandEngine");var n,o,r,h=t.element;if(!c(h)||h.contains(t.editable))return t.debug.logEnd("ABORT. No start element, or start element contains editable."),null;if(r=T(t,function(t,e){return!e.equals(t)},function(t,e){return X(t,!0,e)},h),n=r.upper,o=r.lower,t.debug.logElements([n,o],["Upper","Lower"],"Pair found"),e(t,n,o))return t.debug.logEnd("SUCCESS. Expand trigger created."),r.set(A,S);if(t.debug.logElements([h,n,o],["Start","Upper","Lower"],"Post-processing"),n&&h.contains(n))for(;!n.getParent().equals(h);)n=n.getParent();else n=h.getFirst(function(e){return s(t,e)});if(o&&h.contains(o))for(;!o.getParent().equals(h);)o=o.getParent();else o=h.getLast(function(e){return s(t,e)});if(!n||!o)return t.debug.logEnd("ABORT. There is no upper or no lower element."),null;if(w(t,n),w(t,o),!i(t,n,o))return t.debug.logEnd("ABORT. Mouse is already above upper or below lower."),null;for(var v,l,u,d,_=Number.MAX_VALUE;o&&!o.equals(n)&&(l=n.getNext(t.isRelevant));)v=Math.abs(a(t,n,l)-t.mouse.y),_>v&&(_=v,u=n,d=l),n=l,w(t,n);return t.debug.logElements([u,d],["Min","MinNext"],"Post-processing results"),u&&d?i(t,u,d)?(r.upper=u,r.lower=d,t.debug.logEnd("SUCCESSFUL post-processing. Trigger created."),r.set(A,S)):(t.debug.logEnd("ABORT. Mouse is already above minElement or below minElementNext."),null):(t.debug.logEnd("ABORT. No Min or MinNext"),null)}function s(t,e){return!(p(e)||K(e)||d(e)||l(t,e)||e.type==CKEDITOR.NODE_ELEMENT&&e.$&&e.is("br"))}function i(t,e,s){return o(t.mouse.y,e.size.top,s.size.bottom)}function n(t,s){t.debug.groupStart("expandFilter");var i=s.upper,a=s.lower;return!i||!a||d(a)||d(i)||a.equals(i)||i.equals(a)||a.contains(i)||i.contains(a)?(t.debug.logEnd("REJECTED. No upper or no lower or they contain each other."),!1):m(t,i)&&m(t,a)&&e(t,i,a)?(t.debug.logElementsEnd([i,a],["upper","lower"],"APPROVED EDGE_MIDDLE"),!0):(t.debug.logElementsEnd([i,a],["upper","lower"],"Rejected unknown pair"),!1)}return function(e){e.debug.groupStart("triggerExpand");var s=t(e);return e.debug.groupEnd(),s&&n(e,s)?s:null}}(),Y=["top","left","right","bottom"]}(),CKEDITOR.config.magicline_keystrokePrevious=CKEDITOR.CTRL+CKEDITOR.SHIFT+219,CKEDITOR.config.magicline_keystrokeNext=CKEDITOR.CTRL+CKEDITOR.SHIFT+221;